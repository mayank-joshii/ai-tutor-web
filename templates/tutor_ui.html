<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tutor â€” Ask & Quiz</title>

  <!-- Django will replace {{ csrf_token }} when rendering the template -->
  <meta name="csrf-token" content="{{ csrf_token }}">

  <style>
    :root{
      --bg:#071127; --muted:#9ab0c1; --card:rgba(255,255,255,0.03);
      --accent:#6c5ce7; --success:#10b981; --danger:#ff6b6b;
      --radius:12px; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background: linear-gradient(180deg,#041026 0%, #071127 60%); color:#e6eef8;
      display:flex; align-items:flex-start; justify-content:center; padding:28px;
    }
    .wrap{width:100%; max-width:1100px; display:grid; grid-template-columns:360px 1fr; gap:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.03)}
    .left .title{display:flex; gap:12px; align-items:center}
    .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#9b7bff);display:flex;align-items:center;justify-content:center;font-weight:800}
    h2{margin:0;font-size:18px}
    .muted{color:var(--muted); font-size:13px}

    label{display:block; font-size:13px; color:var(--muted); margin-top:12px}
    input[type="text"], select { width:100%; padding:10px 12px; margin-top:6px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:inherit; }
    button{cursor:pointer}
    .btn{padding:10px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent), #9b7bff); color:white; font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04); color:var(--muted); font-weight:600}
    .hint{font-size:13px;color:var(--muted); margin-top:10px}

    .result{min-height:420px}
    .topic{font-size:20px;font-weight:800}
    .meta{color:var(--muted); font-size:13px}

    .explanation{white-space:pre-wrap; color:#dff1ff; margin-top:12px}
    .codeblock{background:#021423;padding:12px;border-radius:8px;font-family:ui-monospace,Menlo,monospace;color:#a9f0ff;margin-top:10px;overflow:auto}

    .quiz{display:flex;flex-direction:column; gap:12px; margin-top:12px}
    .q{padding:12px;border-radius:8px;background:rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02)}
    .qtitle{font-weight:700;margin-bottom:8px}
    .opts{display:flex;flex-direction:column;gap:8px}
    label.opt{display:flex;gap:10px;align-items:flex-start;padding:8px;border-radius:8px;cursor:pointer}
    input[type="radio"]{margin-top:4px;width:18px;height:18px}

    .correct{border:1px solid rgba(16,185,129,0.12); background:linear-gradient(90deg, rgba(16,185,129,0.04), transparent)}
    .wrong{border:1px solid rgba(239,68,68,0.08); background:linear-gradient(90deg, rgba(239,68,68,0.03), transparent)}

    .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
    .badge{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.03); font-weight:800}

    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: form -->
    <aside class="card left">
      <div class="title">
        <div class="logo">AI</div>
        <div>
          <h2>Tutor â€” Ask & Quiz</h2>
          <div class="muted">Enter a topic & select level to generate an explanation and a short quiz.</div>
        </div>
      </div>

      <label for="topicInput">Topic</label>
      <input id="topicInput" type="text" placeholder="e.g., Loops in Python" autocomplete="off">

      <label for="levelSelect">Level</label>
      <select id="levelSelect" aria-label="Level">
        <option value="beginner">Beginner</option>
        <option value="intermediate">Intermediate</option>
        <option value="advanced">Advanced</option>
      </select>

      <label for="tokenInput">Authorization token (optional)</label>
      <input id="tokenInput" type="text" placeholder="Paste Bearer token if required">

      <div style="display:flex; gap:8px; margin-top:14px;">
        <button id="askBtn" class="btn">Get Explanation & Quiz</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div id="statusMsg" class="hint" aria-live="polite"></div>
      <div id="errorMsg" style="color:var(--danger); font-weight:700; margin-top:8px; display:none"></div>

      <div class="hint" style="margin-top:14px">This page posts to the same URL â€” after you place this in <code>templates/</code>, visit <strong>/tutor</strong>.</div>
    </aside>

    <!-- RIGHT: result -->
    <main class="card result" id="resultArea" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="topic" id="topicTitle">Awaiting input</div>
          <div class="meta" id="metaInfo">Submit a topic to see results</div>
        </div>
        <div style="text-align:right"><div class="badge" id="statusBadge">Idle</div></div>
      </div>

      <section id="explanationCard" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <strong>Explanation</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="toggleExpl" class="btn ghost small">Collapse</button>
            <button id="downloadBtn" class="btn ghost small">Download JSON</button>
            <button id="copyBtn" class="btn ghost small">Copy JSON</button>
          </div>
        </div>
        <div id="explanationArea" class="explanation"></div>
      </section>

      <section id="quizCard" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
          <strong>Quiz</strong>
          <div class="meta">Choose answers and press Submit</div>
        </div>

        <div id="quizArea" class="quiz"></div>

        <div class="controls">
          <button id="submitQuizBtn" class="btn">Submit</button>
          <button id="resetQuizBtn" class="btn ghost">Reset</button>
          <div id="scoreBox" style="margin-left:auto; display:none; align-items:center">
            <span class="badge" id="scoreBadge">0 / 0</span>
            <span class="meta" id="scoreText" style="margin-left:10px"></span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  // ------------------ Utilities ------------------
  const el = id => document.getElementById(id);
  function showError(msg){ el('errorMsg').style.display='block'; el('errorMsg').textContent = msg; }
  function hideError(){ el('errorMsg').style.display='none'; el('errorMsg').textContent = ''; }
  function setStatus(s){ el('statusMsg').textContent = s; el('statusBadge').textContent = s || 'Idle'; }

  // Parse quiz field (handles array, raw JSON string, or ```json ... ``` fence)
  function safeParseQuiz(quizField){
    if(!quizField) return null;
    if(Array.isArray(quizField)) return quizField;
    if(typeof quizField !== 'string') return null;

    const fence = quizField.match(/```(?:json)?\s*([\s\S]*?)```/i);
    let raw = fence ? fence[1].trim() : quizField.trim();
    raw = raw.replace(/^["'\n]+|["'\n]+$/g,'').trim();

    try{
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) return parsed;
      return parsed;
    }catch(e){
      const arrMatch = raw.match(/(\[[\s\S]*\])/);
      if(arrMatch){
        try { return JSON.parse(arrMatch[1]); } catch(err){ return null; }
      }
      return null;
    }
  }

  function renderExplanation(raw){
    const area = el('explanationArea');
    if(!raw){ area.innerHTML = '<div style="color:var(--muted)">No explanation provided.</div>'; return; }
    // convert code fences to code blocks
    let replaced = raw.replace(/```([\w-]*)\n([\s\S]*?)```/g, function(_, lang, code){
      const esc = code.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return `<div class="codeblock"><div style="font-size:12px;color:var(--muted);margin-bottom:6px">${lang||'code'}</div><pre style="margin:0;white-space:pre-wrap">${esc}</pre></div>`;
    });
    replaced = replaced.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    area.innerHTML = replaced;
  }

  // ------------------ Quiz rendering ------------------
  let currentData = null;
  let userAnswers = [];

  function buildQuiz(parsedQuiz){
    const quizArea = el('quizArea');
    quizArea.innerHTML = '';
    userAnswers = Array(parsedQuiz.length).fill(null);

    parsedQuiz.forEach((q, qi) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'q';
      wrapper.dataset.index = qi;

      const title = document.createElement('div');
      title.className = 'qtitle';
      title.textContent = (qi+1) + '. ' + (q.question || 'Question');

      const opts = document.createElement('div');
      opts.className = 'opts';

      const options = Array.isArray(q.options) ? q.options : [];

      options.forEach((opt, oi) => {
        const id = `q${qi}_opt${oi}`;
        const label = document.createElement('label');
        label.className = 'opt';
        label.htmlFor = id;

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'q' + qi;
        radio.id = id;
        radio.value = oi;

        radio.addEventListener('change', () => {
          userAnswers[qi] = oi;
        });

        const text = document.createElement('div');
        text.style.flex = '1';
        text.innerHTML = opt;

        label.appendChild(radio);
        label.appendChild(text);
        opts.appendChild(label);
      });

      wrapper.appendChild(title);
      wrapper.appendChild(opts);
      quizArea.appendChild(wrapper);
    });

    el('scoreBox').style.display = 'none';
    el('scoreBadge').textContent = `0 / ${parsedQuiz.length}`;
    el('scoreText').textContent = '';
  }

  // ------------------ Event wiring ------------------
  el('askBtn').addEventListener('click', async () => {
    hideError();
    setStatus('Loading...');
    el('explanationCard').style.display = 'none';
    el('quizCard').style.display = 'none';

    const topic = el('topicInput').value.trim();
    const level = el('levelSelect').value;
    const token = el('tokenInput').value.trim();

    if(!topic){ showError('Please enter a Topic.'); setStatus('Idle'); return; }

    // Read CSRF token injected by Django
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfMeta ? csrfMeta.content : null;

    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken) headers['X-CSRFToken'] = csrfToken;
    if (token) headers['Authorization'] = token.startsWith('Bearer ') ? token : ('Bearer ' + token);

    try{
      const resp = await fetch(window.location.pathname, {
        method: 'POST',
        credentials: 'include', // important for session auth
        headers,
        body: JSON.stringify({ Topic: topic, level: level })
      });

      const text = await resp.text();
      if(!resp.ok){
        let msg = `Request failed: ${resp.status} ${resp.statusText}`;
        try{ const parsed = JSON.parse(text); msg += ' â€” ' + (parsed.error ? JSON.stringify(parsed.error) : JSON.stringify(parsed)); }catch(e){ msg += ' â€” ' + text; }
        showError(msg);
        setStatus('Error');
        return;
      }

      const data = JSON.parse(text);
      currentData = data;

      el('topicTitle').textContent = data.topic || topic;
      el('metaInfo').textContent = data.log_id ? ('log id: ' + data.log_id) : '';

      // explanation
      renderExplanation(data.explanation || '');

      // quiz
      const parsedQuiz = safeParseQuiz(data.quiz);
      if(!parsedQuiz){
        el('quizArea').innerHTML = `<div style="color:var(--muted)">Quiz not valid JSON. Raw response shown:</div><pre class="codeblock">${escapeHtml(String(data.quiz||''))}</pre>`;
        el('submitQuizBtn').disabled = true;
        el('resetQuizBtn').disabled = true;
      } else {
        buildQuiz(parsedQuiz);
        el('submitQuizBtn').disabled = false;
        el('resetQuizBtn').disabled = false;
        currentData._parsedQuiz = parsedQuiz;
      }

      el('explanationCard').style.display = '';
      el('quizCard').style.display = '';
      setStatus('Done');

    }catch(err){
      showError('Request failed: ' + err.message);
      setStatus('Error');
    }
  });

  el('clearBtn').addEventListener('click', () => {
    el('topicInput').value = '';
    el('tokenInput').value = '';
    el('levelSelect').value = 'beginner';
    hideError();
    setStatus('Idle');
    el('explanationCard').style.display = 'none';
    el('quizCard').style.display = 'none';
    el('topicTitle').textContent = 'Awaiting input';
    el('metaInfo').textContent = 'Submit a topic to see results';
  });

  el('toggleExpl').addEventListener('click', () => {
    const area = el('explanationArea');
    if(area.style.display === 'none'){ area.style.display = ''; el('toggleExpl').textContent = 'Collapse'; }
    else { area.style.display = 'none'; el('toggleExpl').textContent = 'Expand'; }
  });

  el('downloadBtn').addEventListener('click', () => {
    if(!currentData) return;
    const payload = { topic: currentData.topic, explanation: currentData.explanation, quiz: currentData._parsedQuiz ?? currentData.quiz, log_id: currentData.log_id };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = (payload.topic ? payload.topic.replace(/\s+/g,'_').toLowerCase() : 'tutor_result') + '.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  el('copyBtn').addEventListener('click', async () => {
    if(!currentData) return;
    const payload = { topic: currentData.topic, explanation: currentData.explanation, quiz: currentData._parsedQuiz ?? currentData.quiz, log_id: currentData.log_id };
    try{ await navigator.clipboard.writeText(JSON.stringify(payload, null, 2)); setStatus('Copied to clipboard'); setTimeout(()=> setStatus(''),1500); }catch(e){ showError('Copy failed: '+e.message); }
  });

  el('submitQuizBtn').addEventListener('click', () => {
    if(!currentData || !currentData._parsedQuiz){ showError('No valid quiz loaded.'); return; }
    hideError();
    const quiz = currentData._parsedQuiz;
    let score = 0;
    quiz.forEach((q, i) => {
      let correct = null;
      if(typeof q.answer === 'number') correct = q.answer;
      else if(typeof q.answer === 'string' && Array.isArray(q.options)){
        const idx = q.options.findIndex(o => o.trim() === q.answer.trim());
        correct = idx >= 0 ? idx : null;
      }
      const qEl = document.querySelector(`.q[data-index="${i}"]`);
      qEl.querySelectorAll('label.opt').forEach(l => l.classList.remove('correct','wrong'));
      const selected = qEl.querySelector('input[type="radio"]:checked');
      if(!selected) return;
      const val = parseInt(selected.value,10);
      if(correct !== null && val === correct){ score++; selected.closest('label.opt').classList.add('correct'); }
      else {
        selected.closest('label.opt').classList.add('wrong');
        if(correct !== null){
          const correctInput = qEl.querySelector(`input[type="radio"][value="${correct}"]`);
          if(correctInput) correctInput.closest('label.opt').classList.add('correct');
        }
      }
    });

    el('scoreBox').style.display = 'flex';
    el('scoreBadge').textContent = `${score} / ${quiz.length}`;
    el('scoreText').textContent = score === quiz.length ? 'Perfect! ðŸŽ‰' : (score >= Math.ceil(quiz.length/2) ? 'Good job.' : 'Keep practicing.');
  });

  el('resetQuizBtn').addEventListener('click', () => {
    document.querySelectorAll('#quizArea input[type="radio"]').forEach(r => r.checked = false);
    document.querySelectorAll('#quizArea label.opt').forEach(l => l.classList.remove('correct','wrong'));
    el('scoreBox').style.display='none';
    hideError();
  });

  // small helper
  function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  </script>
</body>
</html>
